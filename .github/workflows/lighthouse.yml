name: Lighthouse
on:
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        id: lighthouse
        with:
          urls: |
            https://pimjo-olive.vercel.app/
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Extract Lighthouse scores
        id: extract_scores
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = ${{ steps.lighthouse.outputs.manifest }};

            if (results && results.length > 0) {
              const scores = results[0].summary;
              core.setOutput('performance', Math.round(scores.performance * 100));
              core.setOutput('accessibility', Math.round(scores.accessibility * 100));
              core.setOutput('best-practices', Math.round(scores['best-practices'] * 100));
              core.setOutput('seo', Math.round(scores.seo * 100));
            }

      - name: Create generated directory
        run: mkdir -p generated

      - name: Generate Performance Badge
        uses: emibcn/badge-action@v2.0.3
        with:
          label: 'Performance'
          status: ${{ steps.extract_scores.outputs.performance }}
          color: ${{ steps.extract_scores.outputs.performance > 90 && 'green' || steps.extract_scores.outputs.performance > 50 && 'yellow' || 'red' }}
          path: 'generated/performance.svg'

      - name: Generate Accessibility Badge
        uses: emibcn/badge-action@v2.0.3
        with:
          label: 'Accessibility'
          status: ${{ steps.extract_scores.outputs.accessibility }}
          color: ${{ steps.extract_scores.outputs.accessibility > 90 && 'green' || steps.extract_scores.outputs.accessibility > 50 && 'yellow' || 'red' }}
          path: 'generated/accessibility.svg'

      - name: Generate Best Practices Badge
        uses: emibcn/badge-action@v2.0.3
        with:
          label: 'Best Practices'
          status: ${{ steps.extract_scores.outputs.best-practices }}
          color: ${{ steps.extract_scores.outputs.best-practices > 90 && 'green' || steps.extract_scores.outputs.best-practices > 50 && 'yellow' || 'red' }}
          path: 'generated/best-practices.svg'

      - name: Generate SEO Badge
        uses: emibcn/badge-action@v2.0.3
        with:
          label: 'SEO'
          status: ${{ steps.extract_scores.outputs.seo }}
          color: ${{ steps.extract_scores.outputs.seo > 90 && 'green' || steps.extract_scores.outputs.seo > 50 && 'yellow' || 'red' }}
          path: 'generated/seo.svg'

      - name: Commit badges
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add generated/*.svg
          git diff --quiet && git diff --staged --quiet || git commit -m "Update Lighthouse badges"
          git push
